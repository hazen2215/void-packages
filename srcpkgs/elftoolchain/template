# Template file for 'elftoolchain'
pkgname=elftoolchain
version=0.7.1+svn20230416
revision=1
_commit=fea115ec80ece0a0c2271ed2bc25a30a85da990e
build_style=gnu-makefile
make_cmd=bmake
make_build_args="WITH_ADDITIONAL_DOCUMENTATION=no WITH_TESTS=no MANTARGET=man
 $(vopt_if static LDSTATIC=-static)"
make_install_args="${make_build_args} LIBOWN= BINOWN= BINMODE=755
 NONBINMODE=644 DIRMODE=755 MANTARGET=man MANDIR=/usr/share/man"
make_check_target="run-tests"
make_use_env=yes
hostmakedepends="bmake byacc flex"
makedepends="libarchive-devel"
short_desc="Compilation tools and libraries for ELF"
maintainer="hazen2215 <haz@disroot.org>"
license="BSD-2-Clause"
homepage="https://sourceforge.net/projects/elftoolchain"
distfiles="https://github.com/chimera-linux/elftoolchain/archive/${_commit}.tar.gz"
# distfiles="https://downloads.sourceforge.net/sourceforge/elftoolchain/elftoolchain-${version}.tgz"
checksum=671c2641d1e510c58018e5fb66ebf80fab4e774577e8edc6403153c489d09ae2

build_options="static"
build_options_default="static"

if [ "$XBPS_TARGET_LIBC" = "musl" ]; then
	makedepends+=" musl-legacy-compat"
fi

_alts="addr2line ar c++filt nm objcopy ranlib readelf size strings strip"
for a in $_alts; do
	alternatives+=" $a:$a:/usr/bin/et-$a"
	alternatives+=" $a:$a:/usr/share/man/man1/et-$a"
done

post_install() {
	vlicense LICENSE
	chmod 755 ${DESTDIR}/usr/lib/*.so.*
	# install a musl-compatible elfdefinitions.h
	vinstall ${FILESDIR}/elfdefinitions.h 644 usr/include/sys

	for f in $_alts; do
		mv ${DESTDIR}/usr/bin/{,et-}${f}
		mv ${DESTDIR}/usr/share/man/man1/{,et-}${f}.1
	done
}

elftoolchain-devel_package() {
	depends="${sourcepkg}>=${version}_${revision} elftoolchain-libdwarf
	 elftoolchain-libelf elftoolchain-libelftc elftoolchain-libpe"
	short_desc+=" - development files"
	conflicts="binutils-devel elfutils-devel libdwarf-devel"
	pkg_install() {
		vmove usr/include
		vmove "usr/lib/*.a"
		vmove "usr/lib/*.so"
		vmove usr/share/man/man3
		vmove usr/share/man/man5
	}
}

elftoolchain-libdwarf_package() {
	depends="${sourcepkg}>=${version}_${revision}"
	short_desc+=" - libdwarf"
	conflicts="libdwarf"
	pkg_install() {
		vmove "usr/lib/libdwarf.so.*"
	}
}

elftoolchain-libelf_package() {
	depends="${sourcepkg}>=${version}_${revision}"
	short_desc+=" - libelf"
	conflicts="libelf"
	pkg_install() {
		vmove "usr/lib/libelf.so.*"
	}
}

elftoolchain-libelftc_package() {
	depends="${sourcepkg}>=${version}_${revision}"
	short_desc+=" - libelftc"
	pkg_install() {
		vmove "usr/lib/libelftc.so.*"
	}
}

elftoolchain-libpe_package() {
	depends="${sourcepkg}>=${version}_${revision}"
	short_desc+=" - libpe"
	conflicts="pev"
	pkg_install() {
		vmove "usr/lib/libpe.so.*"
	}
}

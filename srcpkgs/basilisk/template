# Template file for 'basilisk'
pkgname=basilisk
version=2023.01.26
revision=1
_UXP_githash=5b21c547de14f8d1cde62b9f247d8fd413bf8b83
create_wrksrc=yes
build_wrksrc="basilisk"
hostmakedepends="autoconf213 perl pkg-config python unzip yasm zip tar
 which"
makedepends="libXt-devel libXcomposite-devel libXdamage-devel
 alsa-lib-devel $(vopt_if oss oss-devel)
 $(vopt_if dbus dbus-glib-devel) $(vopt_if pulseaudio pulseaudio-devel)
 $(vopt_if xscreensaver libXScrnSaver-devel) $(vopt_if sndio sndio-devel)
 $(vopt_if jack jack-devel) $(vopt_if gtk3 gtk+3-devel gtk+-devel)"
short_desc="XUL-based web-browser demonstrating the Unified XUL Platform (UXP)"
maintainer="hazen2215 <haz@disroot.org>"
license="MPL-2.0, GPL-2.0-or-later, LGPL-2.1-or-later"
homepage="https://www.basilisk-browser.org/"
changelog="https://www.basilisk-browser.org/releasenotes.shtml"
distfiles="https://repo.palemoon.org/Basilisk-Dev/Basilisk/archive/v${version}.tar.gz
 https://repo.palemoon.org/MoonchildProductions/UXP/archive/${_UXP_githash}.tar.gz"
checksum="bb688d2cbc364a8fe6eee082f3857e814cd6e25c522b3dc994c12f4874b407b2
 481a7894eeec8b828c111d24f50df447c6e72ad0fa88f8c1340b1a01a39b7177"
patch_args="-Np1 --directory=${build_wrksrc}"

build_options="alsa oss jack dbus pulseaudio xscreensaver sndio gtk3 webrtc"
build_options_default="alsa oss"

if [ "$XBPS_TARGET_NO_ATOMIC8" ]; then
	makedepends+=" libatomic-devel"
fi

post_extract() {
	rmdir basilisk/platform
	mv uxp basilisk/platform
}

post_patch() {
	if [ "$build_option_gtk3" ]; then
		patch -Np1 --directory=${build_wrksrc} -i "${FILESDIR}/no-gtk2.patch"
	fi
}

do_build() {
	cp "${FILESDIR}/mozconfig" ".mozconfig"

	case "$XBPS_TARGET_MACHINE" in
	*-musl)
		echo "ac_add_options --disable-jemalloc" >>.mozconfig
		echo "ac_add_options --disable-gold" >>.mozconfig
		;;
	esac

	case "$XBPS_TARGET_MACHINE" in
	x86_64*|i686*|arm*|aarch64*)
		echo "ac_add_options --disable-elf-hack" >>.mozconfig
		;;
	esac

	if [ "$XBPS_TARGET_NO_ATOMIC8" ]; then
		export LDFLAGS+=" -latomic"
	fi

	if [ "$CROSS_BUILD" ]; then
		export HOST_CFLAGS="${XBPS_CFLAGS}"
		export HOST_CXXFLAGS="${XBPS_CXXFLAGS}"
		export CFLAGS+=" -I${XBPS_CROSS_BASE}/usr/include/alsa \
			-I${XBPS_CROSS_BASE}/usr/include/pulse"
		export CXXFLAGS+=" ${CFLAGS}"
		export LDFLAGS+=" -L${XBPS_CROSS_BASE}/usr/lib"

		export ac_cv_sqlite_secure_delete=yes \
			ac_cv_sqlite_threadsafe=yes \
			ac_cv_sqlite_enable_fts3=yes \
			ac_cv_sqlite_dbstat_vtab=yes \
			ac_cv_sqlite_enable_unlock_notify=yes \
			ac_cv_prog_hostcxx_works=1

		echo "ac_add_options --target=$XBPS_CROSS_TRIPLET" >>.mozconfig
		echo "ac_add_options --host=$XBPS_TRIPLET" >>.mozconfig
	else
		echo "ac_add_options --target=$XBPS_TRIPLET" >>.mozconfig
		echo "ac_add_options --host=$XBPS_TRIPLET" >>.mozconfig
	fi

	# work around large debug symbols on 32-bit hosts
	if [ "$XBPS_WORDSIZE" = "32" ]; then
		echo "ac_add_options --disable-debug-symbols" >>.mozconfig
		export LDFLAGS+=" -Wl,--no-keep-memory"
	fi

	export LDFLAGS+=" -Wl,-rpath=/usr/lib/basilisk"

	# increase default stack size as basilisk uses a recursive js parser
	export LDFLAGS+=" -Wl,-z,stack-size=524288"

	export MOZ_MAKE_FLAGS="${makejobs}"
	export MOZ_NOSPAM=1
	export MOZBUILD_STATE_PATH="mozbuild"

	cat <<! >>.mozconfig
ac_add_options --enable-default-toolkit=cairo-gtk$(vopt_if gtk3 '3' '2')
ac_add_options $(vopt_enable alsa)
ac_add_options $(vopt_enable jack)
ac_add_options $(vopt_enable sndio)
ac_add_options $(vopt_enable dbus)
ac_add_options $(vopt_enable pulseaudio)
ac_add_options $(vopt_enable oss)
ac_add_options $(vopt_enable webrtc)
export MOZ_PKG_SPECIAL=gtk$(vopt_if gtk3 '3' '2')
!

	rm -f old-configure
	./mach build
}

do_install() {
	export MOZBUILD_STATE_PATH="mozbuild"
	DESTDIR="$DESTDIR" ./mach install

	# vinstall basilisk/branding/official/basilisk.desktop 644 \
		# usr/share/applications

	for i in 16 32 48; do
		vinstall basilisk/branding/unofficial/default$i.png 644 \
			usr/share/icons/hicolor/${i}x${i}/apps basilisk.png
	done

	# We don't want the development stuff
	rm -rf ${DESTDIR}/usr/{include,lib/basilisk-devel,share}

	# https://bugzilla.mozilla.org/show_bug.cgi?id=658850
	ln -sf basilisk ${DESTDIR}/usr/lib/basilisk/basilisk-bin
}

# Template file for 'pcsx2'
pkgname=pcsx2
version=1.7.5560
revision=1
_patches=612721e040a6c4b70d18ae285cc670bf4f64a63e
_glslang=11.12.0
_gtest=1.14.0
_rcheevos=3cadf84c30bbc050c0fec79d26e1c8ff504bda42
_fastfloat=6.1.0
build_wrksrc="pcsx2-${version}"
archs="x86_64*"
build_style=cmake
configure_args="
 -DCMAKE_C_COMPILER=clang
 -DCMAKE_CXX_COMPILER=clang++
 -DCMAKE_BUILD_TYPE=Release
 -DCMAKE_DISABLE_PRECOMPILE_HEADERS=ON
 -DDISABLE_ADVANCE_SIMD=ON
 -DENABLE_TESTS=ON
 -DUSE_LINKED_FFMPEG=ON
 -DUSE_VTUNE=OFF
 -DUSE_VULKAN=ON
 -DWAYLAND_API=ON
 -DX11_API=ON
 -DPCSX2_GIT_TAG=v${version}"
make_check_target="unittests"
hostmakedepends="pkg-config clang"
makedepends="SDL2-devel Vulkan-Headers alsa-lib-devel extra-cmake-modules
 ffmpeg-devel fmt-devel libaio-devel libcurl-devel libpcap-devel libpng-devel
 libwebp-devel libzip-devel lz4-devel qt6-base-devel qt6-tools-devel
 rapidyaml-devel vulkan-loader wayland-devel zlib-devel"
depends="desktop-file-utils"
checkdepends="perl"
short_desc="Sony PlayStation 2 emulator"
maintainer="hazen2215 <haz@disroot.org>"
license="GPL-3.0-or-later, LGPL-3.0-or-later"
homepage="http://www.pcsx2.net"
distfiles="https://github.com/PCSX2/pcsx2/archive/refs/tags/v${version}.tar.gz
 https://github.com/PCSX2/pcsx2_patches/archive/${_patches}.tar.gz
 https://github.com/KhronosGroup/glslang/archive/${_glslang}.tar.gz
 https://github.com/google/googletest/archive/refs/tags/v${_gtest}.tar.gz
 https://github.com/RetroAchievements/rcheevos/archive/${_rcheevos}.tar.gz
 https://github.com/fastfloat/fast_float/archive/refs/tags/v${_fastfloat}.tar.gz"
checksum="37818a9a721fe0b897ff2bc5848a2fefd1b4825b53ca6812541c90d426ece6e0
 71f6ce80c5109460e22d3c754ae1d493b2eb4798e6e6a165dc8b69ac09a50919
 7795a97450fecd9779f3d821858fbc2d1a3bf1dd602617d95b685ccbcabc302f
 8ad598c73ad796e0d8280b082cebd82a630d73e73cd3c70057938a6501bba5d7
 f2e623936167b7300c4b65abf6ea096218d2492310438eb3932a76b3cc804ecb
 a9c8ca8ca7d68c2dbb134434044f9c66cfd4c383d5e85c36b704d30f6be82506"

patch_args="-Np1 --directory=${build_wrksrc}"

CXXFLAGS="-Wno-macro-redefined -Wno-deprecated-declarations"

post_extract() {
	rm -r ${build_wrksrc}/3rdparty/glslang/glslang
	rm -r ${build_wrksrc}/3rdparty/gtest
	rm -r ${build_wrksrc}/3rdparty/rcheevos/rcheevos
	mv pcsx2_patches-${_patches} ${build_wrksrc}/patches
	mv glslang-${_glslang} ${build_wrksrc}/3rdparty/glslang/glslang
	mv googletest-${_gtest} ${build_wrksrc}/3rdparty/gtest
	mv rcheevos-${_rcheevos} ${build_wrksrc}/3rdparty/rcheevos/rcheevos
	mv fast_float-${_fastfloat} ${build_wrksrc}/3rdparty/fast_float
}

post_build() {
	bsdtar --strip-components=2 -cvaf patches.zip patches/patches/*.pnach
}

do_install() {
	vmkdir usr/share/applications
	vinstall ${FILESDIR}/PCSX2.desktop 644 usr/share/applications

	cp -a build/bin ${DESTDIR}/usr/lib/PCSX2
	# vmkdir usr/lib/PCSX2/resources
	cp ./patches.zip ${DESTDIR}/usr/lib/PCSX2/resources

	vmkdir usr/bin
	ln -s ../lib/PCSX2/pcsx2-qt ${DESTDIR}/usr/bin/pcsx2
}

# Template file for 'pcsx2'
pkgname=pcsx2
version=1.7.5973
revision=1
_patches=85654677173d10ccabb67c89f0f04e4d527321e9
build_wrksrc="pcsx2-${version}"
archs="x86_64*"
build_style=cmake
configure_args="
 -DCMAKE_C_COMPILER=clang
 -DCMAKE_CXX_COMPILER=clang++
 -DCMAKE_BUILD_TYPE=Release
 -DCMAKE_DISABLE_PRECOMPILE_HEADERS=ON
 -DDISABLE_ADVANCE_SIMD=ON
 -DENABLE_TESTS=ON
 -DUSE_LINKED_FFMPEG=ON
 -DUSE_VTUNE=OFF
 -DUSE_VULKAN=ON
 -DWAYLAND_API=ON
 -DX11_API=ON
 -DPCSX2_GIT_TAG=v${version}"
make_check_target="unittests"
hostmakedepends="pkg-config clang"
makedepends="SDL2-devel alsa-lib-devel extra-cmake-modules ffmpeg-devel
 libcurl-devel libpcap-devel libpng-devel libwebp-devel libzip-devel lz4-devel
 qt6-base-devel qt6-tools-devel shaderc vulkan-loader wayland-devel zlib-devel"
depends="desktop-file-utils gst-plugins-base1"
checkdepends="perl"
short_desc="Sony PlayStation 2 emulator"
maintainer="hazen2215 <haz@disroot.org>"
license="GPL-3.0-or-later, LGPL-3.0-or-later"
homepage="http://www.pcsx2.net"
distfiles="https://github.com/PCSX2/pcsx2/archive/refs/tags/v${version}.tar.gz
 https://github.com/PCSX2/pcsx2_patches/archive/${_patches}.tar.gz"
checksum="ae7c920a5823583c9613673d2746baa10c8997592b21070f42efbd8297121961
 710e9d258b4fb29127d9fa6d9079ded3dfae6afa0ad81ceddf5417f5e9032f2c"

patch_args="-Np1 --directory=${build_wrksrc}"

CXXFLAGS="-Wno-macro-redefined -Wno-deprecated-declarations"

post_extract() {
	mv pcsx2_patches-${_patches} ${build_wrksrc}/patches
}

post_build() {
	bsdtar --strip-components=2 -cvaf patches.zip patches/patches/*.pnach
}

do_install() {
	vmkdir usr/share/applications
	vinstall ${FILESDIR}/PCSX2.desktop 644 usr/share/applications

	cp -a build/bin ${DESTDIR}/usr/lib/PCSX2
	# vmkdir usr/lib/PCSX2/resources
	cp ./patches.zip ${DESTDIR}/usr/lib/PCSX2/resources

	vmkdir usr/bin
	ln -s ../lib/PCSX2/pcsx2-qt ${DESTDIR}/usr/bin/pcsx2
}
